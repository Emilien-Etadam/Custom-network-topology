<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://unpkg.com; style-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com; img-src 'self' data: https:; font-src 'self' data:;">
  <title>Network Topology</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <link rel="stylesheet" href="css/xterm.css">

  <style>
    /* Theme Variables */
    :root {
      --bg: #0f172a;
      --bg-dark: #0b1220;
      --bg-card: rgba(30, 41, 59, 0.82);
      --bg-sidebar: rgba(15, 23, 42, 0.95);
      --bg-input: #0f172a;
      --bg-modal: #1e293b;
      --bg-terminal: #1a1a2e;
      --text-primary: #e6eef8;
      --text-secondary: #94a3b8;
      --text-muted: #64748b;
      --border-color: rgba(255,255,255,0.1);
      --border-light: rgba(255,255,255,0.05);
      --grid-line: rgba(255, 255, 255, 0.05);
      --muted: #94a3b8;
    }

    [data-theme="light"] {
      --bg: #f1f5f9;
      --bg-dark: #e2e8f0;
      --bg-card: rgba(255, 255, 255, 0.95);
      --bg-sidebar: rgba(248, 250, 252, 0.98);
      --bg-input: #ffffff;
      --bg-modal: #ffffff;
      --bg-terminal: #1e293b;
      --text-primary: #1e293b;
      --text-secondary: #475569;
      --text-muted: #64748b;
      --border-color: rgba(0, 0, 0, 0.1);
      --border-light: rgba(0, 0, 0, 0.05);
      --grid-line: rgba(0, 0, 0, 0.08);
      --muted: #64748b;
    }

    body { margin:0; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background: var(--bg-dark); color: var(--text-primary); height:100vh; overflow:hidden; user-select: none; transition: background 0.3s, color 0.3s; }

    /* Main Layout */
    #app-container { display: flex; flex-direction: column; height: 100vh; }
    #main-content { display: flex; flex: 1; overflow: hidden; }
    #viewport-wrapper { flex: 1; position: relative; overflow: hidden; }

    #viewport { width: 100%; height: 100%; overflow: hidden; cursor: grab; }
    #viewport:active { cursor: grabbing; }
    #world { transform-origin: 0 0; width: 100%; height: 100%; position: relative; }

    #grid-layer { width: 300%; height: 300%; position: absolute; top: 0; left: 0; pointer-events: none; background-size: 5vw 5vh; }
    .grid-bg { background-image: linear-gradient(to right, var(--grid-line) 1px, transparent 1px), linear-gradient(to bottom, var(--grid-line) 1px, transparent 1px); }
    .grid-label { position: absolute; font-family: monospace; font-size: 10px; color: var(--text-muted); opacity: 0.5; pointer-events: none; display: flex; align-items: center; justify-content: center; }

    .card { background: var(--bg-card); backdrop-filter: blur(8px); border: 1px solid var(--border-light); border-radius: 14px; }
    .node-container { position: absolute; transform: translate(-50%,-50%); z-index: 10; cursor: pointer; will-change: left, top; }
    .node-container:hover { z-index: 20; box-shadow: 0 0 20px rgba(59, 130, 246, 0.3); }
    .node-container.dragging {
      cursor: grabbing;
      z-index: 100;
      box-shadow: 0 0 30px rgba(59, 130, 246, 0.5), 0 10px 40px rgba(0,0,0,0.4);
      transform: translate(-50%,-50%) scale(1.05);
    }
    #connections-layer { position:absolute; top:0; left:0; width:100%; height:100%; z-index:0; pointer-events:none; overflow:visible; }

    /* Prevent interaction during drag */
    body.dragging-node { cursor: grabbing !important; }
    body.dragging-node * { cursor: grabbing !important; }
    body.dragging-node #viewport { cursor: grabbing !important; }

    @keyframes flow { 0% { stroke-dashoffset: 24; } 100% { stroke-dashoffset: 0; } }
    .animate-flow { animation: flow 1s linear infinite; }
    @keyframes flow-reverse { 0% { stroke-dashoffset: 0; } 100% { stroke-dashoffset: 24; } }
    .animate-flow-reverse { animation: flow-reverse 1s linear infinite; }

    /* --- SIDEBAR PANELS --- */
    #sidebar { width: 320px; background: var(--bg-sidebar); border-left: 1px solid var(--border-color); display: flex; flex-direction: column; overflow: hidden; transition: background 0.3s; }
    .sidebar-panel { display: flex; flex-direction: column; border-bottom: 1px solid var(--border-light); }
    .panel-header { padding: 12px 16px; background: rgba(128,128,128,0.03); font-weight: 700; font-size: 13px; color: var(--text-secondary); display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
    .panel-header:hover { background: rgba(128,128,128,0.08); }
    .panel-content { padding: 12px 16px; overflow-y: auto; max-height: 300px; }
    .panel-content::-webkit-scrollbar { width: 6px; }
    .panel-content::-webkit-scrollbar-track { background: transparent; }
    .panel-content::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 3px; }

    /* --- TERMINAL PANEL --- */
    #terminal-panel { flex: 1; display: flex; flex-direction: column; min-height: 200px; }
    #terminal-container { flex: 1; background: var(--bg-terminal); padding: 8px; overflow: hidden; }
    .terminal-tabs { display: flex; background: rgba(0,0,0,0.2); border-bottom: 1px solid var(--border-light); }
    .terminal-tab { padding: 8px 16px; font-size: 12px; color: var(--text-muted); cursor: pointer; border-bottom: 2px solid transparent; display: flex; align-items: center; gap: 6px; }
    .terminal-tab:hover { color: var(--text-secondary); background: rgba(128,128,128,0.05); }
    .terminal-tab.active { color: var(--text-primary); border-bottom-color: #3b82f6; }
    .terminal-tab .close-btn { opacity: 0; transition: opacity 0.2s; }
    .terminal-tab:hover .close-btn { opacity: 1; }

    /* --- HOST LIST --- */
    .host-row { padding: 8px 12px; display: flex; align-items: center; justify-content: space-between; font-size: 12px; border-radius: 6px; margin-bottom: 4px; background: rgba(128,128,128,0.1); transition: background 0.2s; }
    .host-row:hover { background: rgba(128,128,128,0.15); }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; margin-right: 10px; flex-shrink: 0; }
    .status-text { font-family: monospace; color: var(--text-muted); font-size: 11px; }

    /* --- TOOLBAR --- */
    #toolbar { background: var(--bg-sidebar); border-bottom: 1px solid var(--border-color); padding: 8px 16px; display: flex; align-items: center; gap: 16px; transition: background 0.3s; }
    .toolbar-btn { display: flex; align-items: center; gap: 6px; padding: 6px 12px; border-radius: 6px; font-size: 12px; color: var(--text-secondary); background: rgba(128,128,128,0.08); border: 1px solid var(--border-color); cursor: pointer; transition: all 0.2s; }
    .toolbar-btn:hover { background: rgba(128,128,128,0.15); color: var(--text-primary); }
    .toolbar-btn.active { background: rgba(59, 130, 246, 0.2); border-color: #3b82f6; color: #60a5fa; }
    .toolbar-divider { width: 1px; height: 24px; background: var(--border-color); }

    /* --- MODALS --- */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 100; backdrop-filter: blur(4px); }
    .modal { background: var(--bg-modal); border: 1px solid var(--border-color); border-radius: 12px; width: 480px; max-height: 90vh; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); transition: background 0.3s; }
    .modal-header { padding: 16px 20px; border-bottom: 1px solid var(--border-light); display: flex; justify-content: space-between; align-items: center; }
    .modal-header h3 { font-size: 16px; font-weight: 700; color: var(--text-primary); }
    .modal-body { padding: 20px; }
    .modal-footer { padding: 16px 20px; border-top: 1px solid var(--border-light); display: flex; justify-content: flex-end; gap: 12px; }
    .form-group { margin-bottom: 16px; }
    .form-label { display: block; font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 6px; }
    .form-input { width: 100%; padding: 10px 12px; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 14px; transition: background 0.3s, border-color 0.3s; }
    .form-input:focus { outline: none; border-color: #3b82f6; }
    .btn { padding: 10px 20px; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
    .btn-primary { background: #3b82f6; color: #fff; border: none; }
    .btn-primary:hover { background: #2563eb; }
    .btn-secondary { background: transparent; color: var(--text-secondary); border: 1px solid var(--border-color); }
    .btn-secondary:hover { background: rgba(128,128,128,0.1); color: var(--text-primary); }

    /* --- NETWORK DISCOVERY --- */
    .discovery-progress { height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; overflow: hidden; margin-top: 8px; }
    .discovery-progress-bar { height: 100%; background: #3b82f6; transition: width 0.3s; }
    .discovered-host { padding: 8px 12px; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.2); border-radius: 6px; margin-bottom: 6px; display: flex; justify-content: space-between; align-items: center; }

    /* --- CONTEXT MENU --- */
    .context-menu { position: fixed; background: var(--bg-modal); border: 1px solid var(--border-color); border-radius: 8px; min-width: 180px; z-index: 200; box-shadow: 0 10px 40px rgba(0,0,0,0.5); overflow: hidden; }
    .context-menu-item { padding: 10px 14px; font-size: 13px; color: var(--text-primary); cursor: pointer; display: flex; align-items: center; gap: 10px; }
    .context-menu-item:hover { background: rgba(59, 130, 246, 0.2); }
    .context-menu-item.danger:hover { background: rgba(239, 68, 68, 0.2); color: #f87171; }
    .context-menu-divider { height: 1px; background: var(--border-light); margin: 4px 0; }

    /* --- PORT HANDLES (React Flow style) --- */
    .node-ports { position: absolute; width: 100%; height: 100%; pointer-events: none; top: 0; left: 0; }
    .port-handle {
      position: absolute;
      width: 12px;
      height: 12px;
      background: #1e293b;
      border: 2px solid #3b82f6;
      border-radius: 50%;
      cursor: crosshair;
      pointer-events: auto;
      z-index: 30;
      transition: background 0.15s, box-shadow 0.15s, border-color 0.15s;
    }
    .port-handle:hover {
      background: #3b82f6;
      box-shadow: 0 0 10px rgba(59, 130, 246, 0.8);
    }
    .port-handle.connected {
      background: #22c55e;
      border-color: #22c55e;
    }
    .port-handle.connected:hover {
      background: #16a34a;
      box-shadow: 0 0 10px rgba(34, 197, 94, 0.8);
    }
    .port-label {
      position: absolute;
      font-size: 8px;
      font-family: monospace;
      color: var(--text-primary);
      white-space: nowrap;
      pointer-events: none;
      background: var(--bg-sidebar);
      padding: 2px 5px;
      border-radius: 3px;
      border: 1px solid rgba(59, 130, 246, 0.3);
      opacity: 0;
      transition: opacity 0.15s;
      z-index: 40;
    }
    .port-handle:hover + .port-label { opacity: 1; }
    /* Always visible port labels (output ports or when multiple ports) */
    .port-label.always-visible { opacity: 1; }
    /* Label positioning based on port side */
    .port-label[style*="top: -6px"] { margin-top: -20px; }
    .port-label[style*="bottom: -6px"] { margin-bottom: -20px; bottom: auto; top: calc(100% + 8px); }
    .port-label[style*="left: -6px"] { margin-left: -50px; }
    .port-label[style*="right: -6px"] { margin-right: -50px; right: auto; left: calc(100% + 8px); }

    /* Selectable connections */
    .connection-group { cursor: pointer; }
    .connection-group:hover .connection-main { stroke-opacity: 0.7 !important; }
    .connection-group.selected .connection-main { stroke: #f59e0b !important; stroke-opacity: 1 !important; stroke-width: 3px !important; }
    .connection-group.selected .connection-animated { stroke: #f59e0b !important; }
    .connection-hitbox { stroke: transparent; stroke-width: 20px; fill: none; pointer-events: stroke; cursor: pointer; }

    /* Toast Notifications */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 10px;
      pointer-events: none;
    }
    .toast {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 18px;
      border-radius: 8px;
      background: var(--bg-modal);
      border: 1px solid var(--border-color);
      box-shadow: 0 10px 40px rgba(0,0,0,0.4);
      backdrop-filter: blur(8px);
      min-width: 280px;
      max-width: 400px;
      pointer-events: auto;
      animation: toastSlideIn 0.3s ease;
    }
    .toast.hiding {
      animation: toastSlideOut 0.3s ease forwards;
    }
    @keyframes toastSlideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    @keyframes toastSlideOut {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(100%); opacity: 0; }
    }
    .toast-icon {
      flex-shrink: 0;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .toast-icon svg { width: 14px; height: 14px; }
    .toast.success .toast-icon { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
    .toast.error .toast-icon { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
    .toast.warning .toast-icon { background: rgba(251, 191, 36, 0.2); color: #fbbf24; }
    .toast.info .toast-icon { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
    .toast-content { flex: 1; }
    .toast-title { font-weight: 600; font-size: 13px; color: var(--text-primary); margin-bottom: 2px; }
    .toast-message { font-size: 12px; color: var(--text-secondary); line-height: 1.4; }
    .toast-close {
      flex-shrink: 0;
      padding: 4px;
      color: var(--text-muted);
      cursor: pointer;
      border-radius: 4px;
      transition: all 0.2s;
    }
    .toast-close:hover { background: rgba(128,128,128,0.2); color: var(--text-primary); }

    /* Clickable host rows */
    .host-row { cursor: pointer; transition: background 0.15s; }
    .host-row:hover { background: rgba(59, 130, 246, 0.1); }

    .hidden { display: none !important; }

    /* --- MULTI-SELECT --- */
    .selection-rect {
      position: absolute;
      border: 2px dashed #3b82f6;
      background: rgba(59, 130, 246, 0.1);
      pointer-events: none;
      z-index: 50;
    }
    .node-container.selected {
      box-shadow: 0 0 0 3px #3b82f6, 0 0 20px rgba(59, 130, 246, 0.4);
    }
    .node-container.selected::after {
      content: '';
      position: absolute;
      top: -4px;
      right: -4px;
      width: 16px;
      height: 16px;
      background: #3b82f6;
      border-radius: 50%;
      border: 2px solid var(--bg-card);
    }

    /* --- MINI-MAP --- */
    #minimap {
      position: absolute;
      bottom: 20px;
      left: 20px;
      width: 200px;
      height: 150px;
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      overflow: hidden;
      z-index: 50;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    #minimap-canvas {
      width: 100%;
      height: 100%;
    }
    #minimap-viewport {
      position: absolute;
      border: 2px solid #3b82f6;
      background: rgba(59, 130, 246, 0.15);
      pointer-events: none;
    }
    #minimap-header {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      padding: 4px 8px;
      background: rgba(0,0,0,0.3);
      font-size: 10px;
      color: var(--text-secondary);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #minimap-close {
      cursor: pointer;
      padding: 2px;
      border-radius: 3px;
    }
    #minimap-close:hover {
      background: rgba(255,255,255,0.1);
    }

    /* --- UNDO/REDO TOOLBAR --- */
    .toolbar-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }
    .toolbar-btn:disabled:hover {
      background: rgba(128,128,128,0.08);
      color: var(--text-secondary);
    }

    /* --- CONTAINER NODES --- */
    .node-container.is-container {
      min-width: 200px;
      min-height: 180px;
      width: auto;
      height: auto;
      border: 2px dashed rgba(59, 130, 246, 0.4);
      background: var(--bg-card);
    }
    .node-container.is-container.expanded {
      width: auto;
      height: auto;
    }
    .node-container.is-container.collapsed {
      width: 160px !important;
      height: 80px !important;
      min-width: 160px;
      min-height: 80px;
    }
    .container-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 12px;
      background: rgba(59, 130, 246, 0.1);
      border-bottom: 1px solid rgba(59, 130, 246, 0.2);
      border-radius: 12px 12px 0 0;
      cursor: move;
    }
    .container-header-left {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .container-header-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .container-toggle {
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    .container-toggle:hover {
      background: rgba(255,255,255,0.1);
      color: var(--text-primary);
    }
    .container-icon {
      width: 28px;
      height: 28px;
      border-radius: 6px;
      background: rgba(0,0,0,0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    .container-icon img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .container-icon i {
      width: 14px;
      height: 14px;
      color: var(--text-muted);
    }
    .container-title {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .container-name {
      font-weight: 700;
      font-size: 12px;
      color: var(--text-primary);
    }
    .container-count {
      font-size: 10px;
      color: var(--text-muted);
    }
    .container-status {
      font-size: 9px;
      font-weight: 700;
      padding: 3px 8px;
      border-radius: 4px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .container-status.online {
      background: rgba(34, 197, 94, 0.15);
      color: #22c55e;
    }
    .container-status.offline {
      background: rgba(239, 68, 68, 0.15);
      color: #ef4444;
    }
    .container-subtitle {
      font-size: 10px;
      color: var(--text-muted);
      font-family: monospace;
    }
    .container-type-badge {
      font-size: 9px;
      padding: 2px 6px;
      border-radius: 4px;
      background: rgba(59, 130, 246, 0.2);
      color: #60a5fa;
      font-weight: 600;
      text-transform: uppercase;
    }
    .container-btn {
      padding: 4px;
      border-radius: 4px;
      cursor: pointer;
      color: var(--text-muted);
      transition: all 0.2s;
    }
    .container-btn:hover {
      background: rgba(255,255,255,0.1);
      color: var(--text-primary);
    }
    .container-content {
      padding: 12px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      min-height: 80px;
      position: relative;
    }
    .container-content.collapsed {
      display: none;
    }
    .container-drop-zone {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 10px;
      margin-top: 8px;
      border: 2px dashed var(--border-light);
      border-radius: 8px;
      transition: all 0.2s;
      color: var(--text-muted);
      font-size: 11px;
      background: transparent;
    }
    .container-drop-zone:hover {
      border-color: #3b82f6;
      background: rgba(59, 130, 246, 0.05);
    }
    .container-drop-zone.drag-over {
      border-color: #22c55e;
      background: rgba(34, 197, 94, 0.15);
      color: #22c55e;
    }
    .node-container.is-container.drag-over .container-drop-zone {
      border-color: #22c55e;
      background: rgba(34, 197, 94, 0.1);
    }
    .container-empty-text {
      color: var(--text-muted);
      font-size: 11px;
      text-align: center;
      width: 100%;
      padding: 20px;
    }

    .container-empty {
      color: var(--text-muted);
      font-size: 11px;
      text-align: center;
      width: 100%;
      padding: 15px;
      font-style: italic;
    }

    /* Child nodes inside container */
    .child-node {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-light);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      width: 100%;
    }
    .child-node:hover {
      background: rgba(59, 130, 246, 0.1);
      border-color: #3b82f6;
    }
    .child-node-icon {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: rgba(0,0,0,0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      overflow: hidden;
    }
    .child-node-icon img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .child-node-icon i {
      width: 16px;
      height: 16px;
      color: var(--text-muted);
    }
    .child-node-info {
      flex: 1;
      min-width: 0;
    }
    .child-node-name {
      font-weight: 600;
      font-size: 12px;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .child-node-address {
      font-size: 10px;
      color: var(--text-muted);
      font-family: monospace;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .child-node-status {
      font-size: 9px;
      font-weight: 700;
      padding: 3px 6px;
      border-radius: 4px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      flex-shrink: 0;
    }
    .child-node-status.online {
      background: rgba(34, 197, 94, 0.15);
      color: #22c55e;
    }
    .child-node-status.offline {
      background: rgba(239, 68, 68, 0.15);
      color: #ef4444;
    }

    /* Container type colors */
    .node-container.container-proxmox { border-color: rgba(230, 126, 34, 0.5); }
    .node-container.container-proxmox .container-header { background: rgba(230, 126, 34, 0.15); }
    .node-container.container-proxmox .container-type-badge { background: rgba(230, 126, 34, 0.2); color: #e67e22; }

    .node-container.container-docker { border-color: rgba(41, 128, 185, 0.5); }
    .node-container.container-docker .container-header { background: rgba(41, 128, 185, 0.15); }
    .node-container.container-docker .container-type-badge { background: rgba(41, 128, 185, 0.2); color: #2980b9; }

    .node-container.container-kubernetes { border-color: rgba(50, 110, 200, 0.5); }
    .node-container.container-kubernetes .container-header { background: rgba(50, 110, 200, 0.15); }
    .node-container.container-kubernetes .container-type-badge { background: rgba(50, 110, 200, 0.2); color: #326de6; }

    .node-container.container-vmware { border-color: rgba(100, 100, 100, 0.5); }
    .node-container.container-vmware .container-header { background: rgba(100, 100, 100, 0.15); }
    .node-container.container-vmware .container-type-badge { background: rgba(100, 100, 100, 0.2); color: #888; }

    .node-container.container-rack { border-color: rgba(155, 89, 182, 0.5); }
    .node-container.container-rack .container-header { background: rgba(155, 89, 182, 0.15); }
    .node-container.container-rack .container-type-badge { background: rgba(155, 89, 182, 0.2); color: #9b59b6; }
  </style>
</head>
<body>

<div id="app-container">
  <!-- Toolbar -->
  <div id="toolbar">
    <div style="display: flex; align-items: center; gap: 8px;">
      <i data-lucide="network" class="w-5 h-5 text-blue-400"></i>
      <span class="font-bold text-white">Network Topology</span>
    </div>

    <div class="toolbar-divider"></div>

    <button class="toolbar-btn" id="btn-admin" title="Open Admin Panel">
      <i data-lucide="settings" class="w-4 h-4"></i>
      <span>Admin</span>
    </button>

    <button class="toolbar-btn" id="btn-discover" title="Discover Network Devices">
      <i data-lucide="radar" class="w-4 h-4"></i>
      <span>Discover</span>
    </button>

    <button class="toolbar-btn" id="btn-snap" title="Toggle Snap to Grid">
      <i data-lucide="grid-3x3" class="w-4 h-4"></i>
      <span>Snap to Grid</span>
    </button>

    <div class="toolbar-divider"></div>

    <button class="toolbar-btn" id="btn-import" title="Import Configuration">
      <i data-lucide="upload" class="w-4 h-4"></i>
      <span>Import</span>
    </button>

    <button class="toolbar-btn" id="btn-export" title="Export Configuration">
      <i data-lucide="download" class="w-4 h-4"></i>
      <span>Export</span>
    </button>

    <button class="toolbar-btn" id="btn-export-image" title="Export as Image">
      <i data-lucide="image" class="w-4 h-4"></i>
      <span>Image</span>
    </button>

    <button class="toolbar-btn" id="btn-auto-layout" title="Auto Layout Nodes">
      <i data-lucide="layout-grid" class="w-4 h-4"></i>
      <span>Layout</span>
    </button>

    <div class="toolbar-divider"></div>

    <!-- Undo/Redo -->
    <button class="toolbar-btn" id="btn-undo" title="Undo (Ctrl+Z)" disabled>
      <i data-lucide="undo-2" class="w-4 h-4"></i>
    </button>
    <button class="toolbar-btn" id="btn-redo" title="Redo (Ctrl+Y)" disabled>
      <i data-lucide="redo-2" class="w-4 h-4"></i>
    </button>

    <div class="toolbar-divider"></div>

    <!-- View Controls -->
    <button class="toolbar-btn" id="btn-minimap" title="Toggle Minimap">
      <i data-lucide="map" class="w-4 h-4"></i>
    </button>
    <button class="toolbar-btn" id="btn-theme" title="Toggle Dark/Light Theme">
      <i data-lucide="moon" class="w-4 h-4" id="theme-icon"></i>
    </button>

    <div class="toolbar-divider"></div>

    <!-- Search and Filter -->
    <div style="display: flex; align-items: center; gap: 8px;">
      <div style="position: relative;">
        <i data-lucide="search" class="w-4 h-4" style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: #64748b; pointer-events: none;"></i>
        <input type="text" id="node-search" placeholder="Search nodes..."
               style="padding: 6px 10px 6px 32px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.2); color: #fff; font-size: 12px; width: 160px; outline: none;"
               onfocus="this.style.borderColor='#3b82f6'" onblur="this.style.borderColor='rgba(255,255,255,0.1)'">
      </div>
      <select id="node-filter-status" style="padding: 6px 10px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.2); color: #fff; font-size: 12px; outline: none; cursor: pointer;">
        <option value="all">All Status</option>
        <option value="online">Online</option>
        <option value="offline">Offline</option>
      </select>
    </div>

    <div style="flex:1;"></div>

    <div id="last-updated" class="text-xs text-slate-500 font-mono">Initializing...</div>

    <button class="toolbar-btn" id="btn-monitoring" title="Toggle Monitoring">
      <i data-lucide="activity" class="w-4 h-4"></i>
      <span>Monitoring</span>
    </button>
  </div>

  <div id="main-content">
    <!-- Main Viewport -->
    <div id="viewport-wrapper">
      <div id="viewport">
        <div id="world">
          <div id="grid-layer" class="grid-bg"><div id="grid-labels"></div></div>
          <svg id="connections-layer" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="none"></svg>
          <div id="tree-container" style="position:absolute; inset:0; z-index:20; pointer-events:none;"></div>
          <!-- Selection rectangle for multi-select -->
          <div id="selection-rect" class="selection-rect hidden"></div>
        </div>
      </div>
      <!-- Mini-map -->
      <div id="minimap" class="hidden">
        <div id="minimap-header">
          <span>Mini-map</span>
          <span id="minimap-close"><i data-lucide="x" class="w-3 h-3"></i></span>
        </div>
        <canvas id="minimap-canvas"></canvas>
        <div id="minimap-viewport"></div>
      </div>
    </div>

    <!-- Sidebar -->
    <div id="sidebar">
      <!-- Host Status Panel -->
      <div class="sidebar-panel">
        <div class="panel-header" onclick="togglePanel('host-list')">
          <span><i data-lucide="server" class="w-4 h-4 inline mr-2"></i>Host Status</span>
          <span id="host-count" class="text-xs bg-slate-800 px-2 py-0.5 rounded">0</span>
        </div>
        <div class="panel-content" id="host-list-content">
          <!-- Rows injected here -->
        </div>
      </div>

      <!-- Terminal Panel -->
      <div id="terminal-panel" class="sidebar-panel">
        <div class="panel-header">
          <span><i data-lucide="terminal" class="w-4 h-4 inline mr-2"></i>SSH Terminal</span>
          <span id="terminal-status" class="text-xs px-2 py-0.5 rounded bg-slate-700">No Connection</span>
        </div>
        <div class="terminal-tabs" id="terminal-tabs">
          <!-- Terminal tabs injected here -->
        </div>
        <div id="terminal-container">
          <div id="terminal-placeholder" class="h-full flex items-center justify-center text-slate-500 text-sm">
            <div class="text-center">
              <i data-lucide="terminal" class="w-8 h-8 mx-auto mb-2 opacity-50"></i>
              <p>Right-click a node to open SSH</p>
            </div>
          </div>
          <div id="terminal-instances"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- SSH Connection Modal -->
<div id="ssh-modal" class="modal-overlay hidden">
  <div class="modal">
    <div class="modal-header">
      <h3><i data-lucide="terminal" class="w-5 h-5 inline mr-2"></i>SSH Connection</h3>
      <button onclick="closeModal('ssh-modal')" class="text-slate-400 hover:text-white">
        <i data-lucide="x" class="w-5 h-5"></i>
      </button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">Host</label>
        <input type="text" id="ssh-host" class="form-input" placeholder="192.168.1.1" readonly>
      </div>
      <div class="form-group">
        <label class="form-label">Port</label>
        <input type="number" id="ssh-port" class="form-input" placeholder="22" value="22">
      </div>
      <div class="form-group">
        <label class="form-label">Username</label>
        <input type="text" id="ssh-username" class="form-input" placeholder="root">
      </div>
      <div class="form-group">
        <label class="form-label">Authentication</label>
        <select id="ssh-auth-type" class="form-input" onchange="toggleSSHAuthFields()">
          <option value="password">Password</option>
          <option value="key">Private Key</option>
        </select>
      </div>
      <div id="ssh-password-group" class="form-group">
        <label class="form-label">Password</label>
        <input type="password" id="ssh-password" class="form-input" placeholder="Enter password">
      </div>
      <div id="ssh-key-group" class="form-group hidden">
        <label class="form-label">Private Key</label>
        <div style="display: flex; gap: 8px;">
          <input type="text" id="ssh-key-path" class="form-input" placeholder="Select private key file..." readonly style="flex: 1;">
          <button type="button" class="btn btn-secondary" onclick="browseSSHKey()" style="white-space: nowrap;">
            <i data-lucide="folder-open" class="w-4 h-4"></i>
          </button>
        </div>
        <div class="form-group" style="margin-top: 8px;">
          <label class="form-label">Passphrase (optional)</label>
          <input type="password" id="ssh-passphrase" class="form-input" placeholder="Key passphrase (if encrypted)">
        </div>
      </div>
      <input type="hidden" id="ssh-node-id">
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('ssh-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="connectSSH()">Connect</button>
    </div>
  </div>
</div>

<!-- Network Discovery Modal -->
<div id="discovery-modal" class="modal-overlay hidden">
  <div class="modal">
    <div class="modal-header">
      <h3><i data-lucide="radar" class="w-5 h-5 inline mr-2"></i>Network Discovery</h3>
      <button onclick="closeModal('discovery-modal')" class="text-slate-400 hover:text-white">
        <i data-lucide="x" class="w-5 h-5"></i>
      </button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">Network Interface</label>
        <select id="discovery-interface" class="form-input">
          <!-- Options populated dynamically -->
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">IP Range</label>
        <div class="flex gap-2">
          <input type="text" id="discovery-base" class="form-input" placeholder="192.168.1" style="width:60%">
          <input type="number" id="discovery-start" class="form-input" placeholder="1" value="1" min="1" max="254" style="width:20%">
          <span class="text-slate-400 self-center">-</span>
          <input type="number" id="discovery-end" class="form-input" placeholder="254" value="254" min="1" max="254" style="width:20%">
        </div>
      </div>
      <div id="discovery-status" class="text-sm text-slate-400 hidden">
        <span id="discovery-text">Scanning...</span>
        <div class="discovery-progress">
          <div class="discovery-progress-bar" id="discovery-progress-bar" style="width: 0%"></div>
        </div>
      </div>
      <div id="discovery-results" class="mt-4 max-h-48 overflow-y-auto hidden">
        <!-- Discovered hosts here -->
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('discovery-modal')">Close</button>
      <button class="btn btn-primary" id="btn-start-scan" onclick="startNetworkScan()">Start Scan</button>
      <button class="btn btn-primary hidden" id="btn-add-discovered" onclick="addDiscoveredNodes()">Add Selected</button>
    </div>
  </div>
</div>

<!-- Node Edit Modal -->
<div id="node-modal" class="modal-overlay hidden">
  <div class="modal">
    <div class="modal-header">
      <h3 id="node-modal-title"><i data-lucide="edit" class="w-5 h-5 inline mr-2"></i>Edit Node</h3>
      <button onclick="closeModal('node-modal')" class="text-slate-400 hover:text-white">
        <i data-lucide="x" class="w-5 h-5"></i>
      </button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">Name</label>
        <input type="text" id="node-name" class="form-input" placeholder="Device Name">
      </div>
      <div class="grid grid-cols-2 gap-4">
        <div class="form-group">
          <label class="form-label">IP Address</label>
          <input type="text" id="node-address" class="form-input" placeholder="192.168.1.1">
        </div>
        <div class="form-group">
          <label class="form-label">Port (optional)</label>
          <input type="number" id="node-port" class="form-input" placeholder="e.g. 80">
        </div>
      </div>
      <div class="grid grid-cols-2 gap-4">
        <div class="form-group">
          <label class="form-label">Node Type</label>
          <select id="node-is-container" class="form-input" onchange="toggleContainerOptions()">
            <option value="false">Standard Node</option>
            <option value="true">Container (can hold child nodes)</option>
          </select>
        </div>
        <div class="form-group" id="container-type-group" style="display: none;">
          <label class="form-label">Container Type</label>
          <select id="node-container-type" class="form-input">
            <option value="proxmox">Proxmox (VM/CT)</option>
            <option value="docker">Docker</option>
            <option value="kubernetes">Kubernetes</option>
            <option value="vmware">VMware</option>
            <option value="rack">Physical Rack</option>
            <option value="cloud">Cloud (VPC)</option>
            <option value="custom">Custom Group</option>
          </select>
        </div>
      </div>
      <div class="form-group" id="container-parent-group" style="display: none;">
        <label class="form-label">Parent Container</label>
        <select id="node-parent-container" class="form-input">
          <option value="">No parent (standalone)</option>
        </select>
      </div>
      <div class="grid grid-cols-2 gap-4">
        <div class="form-group">
          <label class="form-label">Primary Parent</label>
          <select id="node-primary-parent" class="form-input"></select>
        </div>
        <div class="form-group">
          <label class="form-label">Failover Parent</label>
          <select id="node-secondary-parent" class="form-input"></select>
        </div>
      </div>
      <div class="grid grid-cols-2 gap-4">
        <div class="form-group">
          <label class="form-label">Link Type</label>
          <select id="node-link-type" class="form-input">
            <option value="">None</option>
            <option value="RJ45">RJ45 (Copper)</option>
            <option value="DAC">DAC (Direct Attach)</option>
            <option value="Fiber">Fiber Optic</option>
            <option value="WiFi">WiFi</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Link Speed</label>
          <select id="node-link-speed" class="form-input">
            <option value="">Not specified</option>
            <option value="100M">100 Mbps</option>
            <option value="1G">1 Gbps</option>
            <option value="2.5G">2.5 Gbps</option>
            <option value="5G">5 Gbps</option>
            <option value="10G">10 Gbps</option>
            <option value="25G">25 Gbps</option>
            <option value="40G">40 Gbps</option>
            <option value="100G">100 Gbps</option>
          </select>
        </div>
      </div>
      <div class="grid grid-cols-3 gap-4">
        <div class="form-group">
          <label class="form-label">Icon Type</label>
          <select id="node-icon-type" class="form-input">
            <option value="lucide">Lucide Icon</option>
            <option value="url">Image URL</option>
            <option value="svg">SVG Code</option>
          </select>
        </div>
        <div class="form-group col-span-2">
          <label class="form-label">Icon</label>
          <input type="text" id="node-icon" class="form-input" placeholder="router">
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">SSH Credentials (optional)</label>
        <div class="grid grid-cols-3 gap-2">
          <input type="number" id="node-ssh-port" class="form-input" placeholder="SSH Port" value="22">
          <input type="text" id="node-ssh-user" class="form-input" placeholder="Username">
          <input type="password" id="node-ssh-pass" class="form-input" placeholder="Password">
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Ports / Interfaces</label>
        <div id="node-ports-list" class="space-y-2 max-h-40 overflow-y-auto mb-2"></div>
        <button type="button" onclick="addNodePort()" class="w-full py-2 border border-dashed border-slate-500 text-slate-400 rounded text-sm hover:border-blue-500 hover:text-blue-400 transition">
          + Add Port
        </button>
      </div>
      <input type="hidden" id="node-edit-id">
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('node-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveNode()">Save</button>
    </div>
  </div>
</div>

<!-- Context Menu -->
<div id="context-menu" class="context-menu hidden">
  <div class="context-menu-item" onclick="openSSHFromContext()">
    <i data-lucide="terminal" class="w-4 h-4"></i>
    <span>SSH Connect</span>
  </div>
  <div class="context-menu-item" onclick="editNodeFromContext()">
    <i data-lucide="edit" class="w-4 h-4"></i>
    <span>Edit Node</span>
  </div>
  <div class="context-menu-divider"></div>
  <div class="context-menu-item" onclick="pingNodeFromContext()">
    <i data-lucide="activity" class="w-4 h-4"></i>
    <span>Ping</span>
  </div>
  <div class="context-menu-item" onclick="showStatusHistoryFromContext()">
    <i data-lucide="clock" class="w-4 h-4"></i>
    <span>Status History</span>
  </div>
  <div id="context-container-section" class="hidden">
    <div class="context-menu-divider"></div>
    <div id="context-container-toggle" class="context-menu-item" onclick="toggleContainerFromContext()">
      <i data-lucide="chevrons-down-up" class="w-4 h-4"></i>
      <span>Collapse Container</span>
    </div>
  </div>
  <div id="context-child-section" class="hidden">
    <div class="context-menu-divider"></div>
    <div class="context-menu-item" onclick="removeFromContainerFromContext()">
      <i data-lucide="log-out" class="w-4 h-4"></i>
      <span>Remove from Container</span>
    </div>
  </div>
  <div id="context-add-to-container-section" class="hidden">
    <div class="context-menu-divider"></div>
    <div id="context-add-to-container-items"></div>
  </div>
  <div class="context-menu-divider"></div>
  <div class="context-menu-item danger" onclick="deleteNodeFromContext()">
    <i data-lucide="trash-2" class="w-4 h-4"></i>
    <span>Delete Node</span>
  </div>
</div>

<!-- Toast Container -->
<div id="toast-container" class="toast-container"></div>

<script src="js/app.js"></script>
</body>
</html>
