<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://unpkg.com; style-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com; img-src 'self' data: https:; font-src 'self' data:;">
    <title>Network Topology Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        :root { --bg:#0f172a; --muted:#94a3b8; }
        body { margin:0; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background: #0b1220; color:#e6eef8; min-height: 100vh; }

        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.2); }
    </style>
</head>
<body class="bg-slate-900 text-slate-200 p-6 font-sans">

    <div class="max-w-[1600px] mx-auto">
        <!-- Header -->
        <div class="flex justify-between items-center mb-6">
            <div class="flex items-center gap-4">
                <button onclick="goBack()" class="p-2 hover:bg-slate-800 rounded-lg transition" title="Back to Viewer">
                    <i data-lucide="arrow-left" class="w-5 h-5"></i>
                </button>
                <div>
                    <h1 class="text-2xl font-bold text-white">Network Topology Admin</h1>
                    <p class="text-slate-400 text-sm mt-1">Configure hosts, failover paths, and layout positions.</p>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <!-- Settings -->
                <div class="flex items-center gap-4 bg-slate-800/50 px-4 py-2 rounded-lg border border-slate-700">
                    <div class="flex items-center space-x-2">
                        <input type="checkbox" id="showGridCheck" class="w-4 h-4 rounded bg-slate-700 border-slate-500 text-blue-600 focus:ring-blue-500">
                        <label for="showGridCheck" class="text-sm font-medium text-slate-300 cursor-pointer">Show Grid</label>
                    </div>
                    <div class="w-px h-6 bg-slate-600"></div>
                    <div class="flex items-center space-x-2">
                        <input type="checkbox" id="snapToGridCheck" class="w-4 h-4 rounded bg-slate-700 border-slate-500 text-blue-600 focus:ring-blue-500">
                        <label for="snapToGridCheck" class="text-sm font-medium text-slate-300 cursor-pointer">Snap to Grid</label>
                    </div>
                </div>

                <!-- Import/Export -->
                <div class="flex items-center gap-2">
                    <button onclick="importConfig()" class="flex items-center gap-2 bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded-lg transition text-sm font-medium">
                        <i data-lucide="upload" class="w-4 h-4"></i>
                        Import
                    </button>
                    <button onclick="exportConfig()" class="flex items-center gap-2 bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg font-bold transition shadow-lg shadow-blue-500/20 text-sm">
                        <i data-lucide="download" class="w-4 h-4"></i>
                        Export
                    </button>
                    <button onclick="saveConfig()" class="flex items-center gap-2 bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded-lg font-bold transition shadow-lg shadow-green-500/20 text-sm">
                        <i data-lucide="save" class="w-4 h-4"></i>
                        Save
                    </button>
                </div>
            </div>
        </div>

        <!-- Stats Bar -->
        <div class="grid grid-cols-4 gap-4 mb-6">
            <div class="bg-slate-800/50 rounded-lg p-4 border border-slate-700">
                <div class="text-sm text-slate-400">Total Nodes</div>
                <div class="text-2xl font-bold text-white" id="stat-total">0</div>
            </div>
            <div class="bg-slate-800/50 rounded-lg p-4 border border-slate-700">
                <div class="text-sm text-slate-400">Root Nodes</div>
                <div class="text-2xl font-bold text-blue-400" id="stat-roots">0</div>
            </div>
            <div class="bg-slate-800/50 rounded-lg p-4 border border-slate-700">
                <div class="text-sm text-slate-400">With Failover</div>
                <div class="text-2xl font-bold text-yellow-400" id="stat-failover">0</div>
            </div>
            <div class="bg-slate-800/50 rounded-lg p-4 border border-slate-700">
                <div class="text-sm text-slate-400">SSH Configured</div>
                <div class="text-2xl font-bold text-green-400" id="stat-ssh">0</div>
            </div>
        </div>

        <!-- Editor Table -->
        <div class="bg-slate-800 rounded-xl border border-slate-700 overflow-hidden shadow-xl">
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse min-w-[1100px]">
                    <thead class="bg-slate-900/50 text-slate-400 uppercase text-xs font-bold tracking-wider sticky top-0">
                        <tr>
                            <th class="p-4 w-48">Node Name</th>
                            <th class="p-4 w-48">IP Address / Port</th>
                            <th class="p-4 w-56">Parents</th>
                            <th class="p-4 w-48">SSH Credentials</th>
                            <th class="p-4 w-40">Icon</th>
                            <th class="p-4 w-16 text-center">Preview</th>
                            <th class="p-4 w-16 text-right"></th>
                        </tr>
                    </thead>
                    <tbody id="hostList"></tbody>
                </table>
            </div>

            <div class="p-4 bg-slate-900/30 border-t border-slate-700">
                <button onclick="addRow()" class="w-full py-3 border-2 border-dashed border-slate-600 text-slate-500 rounded-lg hover:border-blue-500 hover:text-blue-400 transition flex items-center justify-center gap-2 font-medium">
                    <i data-lucide="plus-circle" class="w-5 h-5"></i> Add New Device Node
                </button>
            </div>
        </div>

        <!-- Help Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6">
            <div class="p-4 bg-blue-900/20 border border-blue-600/30 rounded-lg text-blue-200 text-sm">
                <strong class="block mb-2 text-blue-400 flex items-center gap-2"><i data-lucide="move" class="w-4 h-4"></i> Positioning</strong>
                <p class="text-blue-300/80 text-xs">Drag and drop nodes directly on the canvas to position them. Positions are saved automatically.</p>
            </div>
            <div class="p-4 bg-red-900/20 border border-red-600/30 rounded-lg text-red-200 text-sm">
                <strong class="block mb-2 text-red-400 flex items-center gap-2"><i data-lucide="zap" class="w-4 h-4"></i> Failover</strong>
                <p class="text-red-300/80 text-xs">System switches to Secondary Parent automatically if Primary is offline.</p>
            </div>
            <div class="p-4 bg-green-900/20 border border-green-600/30 rounded-lg text-green-200 text-sm">
                <strong class="block mb-2 text-green-400 flex items-center gap-2"><i data-lucide="terminal" class="w-4 h-4"></i> SSH Access</strong>
                <p class="text-green-300/80 text-xs">Configure SSH credentials for quick terminal access from the topology viewer.</p>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();

        let hosts = [];
        let settings = { showGrid: true, snapToGrid: true };

        // ============================================
        // Initialization
        // ============================================

        async function init() {
            await loadConfig();
            setupEventListeners();
            updateStats();
        }

        async function loadConfig() {
            try {
                if (window.electronAPI) {
                    const config = await window.electronAPI.config.load();
                    hosts = (config.nodes || []).map(normalizeHost);
                    settings = config.settings || settings;
                } else {
                    // Browser fallback
                    const res = await fetch('config.json');
                    if (res.ok) {
                        const data = await res.json();
                        hosts = (data.nodes || []).map(normalizeHost);
                        settings = data.settings || settings;
                    }
                }
            } catch (e) {
                console.error('Failed to load config:', e);
                hosts = [];
            }

            document.getElementById('showGridCheck').checked = settings.showGrid;
            document.getElementById('snapToGridCheck').checked = settings.snapToGrid !== false;
            render();
        }

        function setupEventListeners() {
            document.getElementById('showGridCheck').addEventListener('change', (e) => {
                settings.showGrid = e.target.checked;
            });
            document.getElementById('snapToGridCheck').addEventListener('change', (e) => {
                settings.snapToGrid = e.target.checked;
            });
        }

        function normalizeHost(h) {
            return {
                id: h.id || ('node_' + Date.now() + '_' + Math.floor(Math.random() * 1000)),
                name: h.name || 'Unnamed',
                address: h.address || '',
                port: (h.port === '' || typeof h.port === 'undefined') ? null : h.port,
                primaryParentId: (h.primaryParentId && h.primaryParentId !== '') ? h.primaryParentId : null,
                secondaryParentId: (h.secondaryParentId && h.secondaryParentId !== '') ? h.secondaryParentId : null,
                icon: h.icon || 'circle',
                iconType: h.iconType || 'lucide',
                x: (h.x === null || h.x === '') ? null : h.x,
                y: (h.y === null || h.y === '') ? null : h.y,
                sshPort: h.sshPort || 22,
                sshUser: h.sshUser || '',
                sshPass: h.sshPass || ''
            };
        }

        // ============================================
        // Rendering
        // ============================================

        function render() {
            const tbody = document.getElementById('hostList');
            tbody.innerHTML = '';

            hosts.forEach((host, index) => {
                const tr = document.createElement('tr');
                tr.className = "border-b border-slate-700 hover:bg-slate-700/30 transition group";

                const createParentOptions = (currentParentId) => {
                    let options = `<option value="" ${currentParentId === null ? 'selected' : ''}>No Parent (Root)</option>`;
                    hosts.forEach(h => {
                        if (h.id !== host.id) {
                            const selected = currentParentId === h.id ? 'selected' : '';
                            options += `<option value="${h.id}" ${selected}>${escapeHtml(h.name)}</option>`;
                        }
                    });
                    return options;
                };

                tr.innerHTML = `
                    <td class="p-3 align-top">
                        <input type="text" value="${escapeHtml(host.name)}" onchange="update(${index}, 'name', this.value)"
                            class="bg-slate-900 border border-slate-600 rounded px-3 py-2 w-full text-sm focus:border-blue-500 outline-none text-slate-200" placeholder="Device Name">
                    </td>
                    <td class="p-3 align-top">
                        <div class="flex gap-2">
                            <input type="text" value="${escapeHtml(host.address)}" onchange="update(${index}, 'address', this.value)"
                                class="bg-slate-900 border border-slate-600 rounded px-2 py-2 w-28 text-sm font-mono focus:border-blue-500 outline-none" placeholder="IP">
                            <input type="number" value="${host.port || ''}" onchange="update(${index}, 'port', this.value)"
                                class="bg-slate-900 border border-slate-600 rounded px-2 py-2 w-16 text-sm font-mono focus:border-blue-500 outline-none" placeholder="Port">
                        </div>
                    </td>
                    <td class="p-3 align-top">
                        <div class="flex flex-col gap-2">
                            <div class="flex items-center gap-1">
                                <span class="text-[10px] text-slate-500 w-8">Pri:</span>
                                <select onchange="update(${index}, 'primaryParentId', this.value)"
                                    class="bg-slate-900 border border-slate-600 rounded px-2 py-1.5 flex-1 text-xs outline-none cursor-pointer">
                                    ${createParentOptions(host.primaryParentId)}
                                </select>
                            </div>
                            <div class="flex items-center gap-1">
                                <span class="text-[10px] text-yellow-500 w-8">Fail:</span>
                                <select onchange="update(${index}, 'secondaryParentId', this.value)"
                                    class="bg-slate-900 border border-slate-600 rounded px-2 py-1.5 flex-1 text-xs outline-none cursor-pointer">
                                    ${createParentOptions(host.secondaryParentId)}
                                </select>
                            </div>
                        </div>
                    </td>
                    <td class="p-3 align-top">
                        <div class="flex flex-col gap-1">
                            <div class="flex gap-1">
                                <input type="number" value="${host.sshPort || 22}" onchange="update(${index}, 'sshPort', this.value)"
                                    class="bg-slate-900 border border-slate-600 rounded px-2 py-1 w-14 text-xs font-mono outline-none" placeholder="22">
                                <input type="text" value="${escapeHtml(host.sshUser)}" onchange="update(${index}, 'sshUser', this.value)"
                                    class="bg-slate-900 border border-slate-600 rounded px-2 py-1 flex-1 text-xs outline-none" placeholder="User">
                            </div>
                            <input type="password" value="${escapeHtml(host.sshPass)}" onchange="update(${index}, 'sshPass', this.value)"
                                class="bg-slate-900 border border-slate-600 rounded px-2 py-1 w-full text-xs outline-none" placeholder="Password">
                        </div>
                    </td>
                    <td class="p-3 align-top">
                        <div class="flex gap-1 items-center">
                            <select onchange="updateIconType(${index}, this.value)"
                                class="bg-slate-900 border border-slate-600 rounded text-xs p-1.5 w-14 cursor-pointer">
                                <option value="lucide" ${host.iconType === 'lucide' ? 'selected' : ''}>Icon</option>
                                <option value="url" ${host.iconType === 'url' ? 'selected' : ''}>URL</option>
                                <option value="svg" ${host.iconType === 'svg' ? 'selected' : ''}>SVG</option>
                            </select>
                            <input type="text" value="${escapeHtml(host.icon)}" onchange="update(${index}, 'icon', this.value)"
                                class="bg-slate-900 border border-slate-600 rounded px-2 py-1.5 flex-1 text-xs outline-none"
                                placeholder="${host.iconType === 'svg' ? 'SVG code' : 'name'}">
                        </div>
                    </td>
                    <td class="p-3 text-center align-top">
                        <div class="w-10 h-10 bg-slate-800 rounded-full flex items-center justify-center border border-slate-600 mx-auto overflow-hidden">
                            ${renderIconPreview(host)}
                        </div>
                    </td>
                    <td class="p-3 text-right align-top">
                        <div class="flex flex-col gap-1">
                            <button onclick="duplicateRow(${index})" class="text-slate-500 hover:text-blue-400 hover:bg-blue-900/20 p-1.5 rounded transition" title="Duplicate">
                                <i data-lucide="copy" class="w-4 h-4"></i>
                            </button>
                            <button onclick="removeRow(${index})" class="text-slate-500 hover:text-red-400 hover:bg-red-900/20 p-1.5 rounded transition" title="Delete">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            lucide.createIcons();
            updateStats();
        }

        function renderIconPreview(host) {
            if (host.iconType === 'url') {
                return `<img src="${host.icon}" class="w-full h-full object-cover" onerror="this.style.display='none'">`;
            }
            if (host.iconType === 'svg') {
                const svgContent = host.icon.trim();
                if (svgContent.startsWith('<svg') && svgContent.endsWith('>')) {
                    return host.icon;
                }
                return `<div class="text-[8px] text-slate-500">SVG</div>`;
            }
            return `<i data-lucide="${host.icon || 'circle'}" class="w-5 h-5 text-slate-400"></i>`;
        }

        function updateStats() {
            document.getElementById('stat-total').textContent = hosts.length;
            document.getElementById('stat-roots').textContent = hosts.filter(h => !h.primaryParentId).length;
            document.getElementById('stat-failover').textContent = hosts.filter(h => h.secondaryParentId).length;
            document.getElementById('stat-ssh').textContent = hosts.filter(h => h.sshUser).length;
        }

        // ============================================
        // Actions
        // ============================================

        function addRow() {
            const newHost = normalizeHost({});
            // Auto-position new node
            const col = hosts.length % 10;
            const row = Math.floor(hosts.length / 10);
            newHost.x = (col * 10) + 5;
            newHost.y = (row * 15) + 10;
            hosts.push(newHost);
            render();
        }

        function duplicateRow(index) {
            const original = hosts[index];
            const duplicate = { ...original };
            duplicate.id = 'node_' + Date.now();
            duplicate.name = original.name + ' (copy)';
            // Offset position slightly
            if (duplicate.x !== null) duplicate.x = Math.min(95, duplicate.x + 5);
            if (duplicate.y !== null) duplicate.y = Math.min(95, duplicate.y + 5);
            hosts.splice(index + 1, 0, duplicate);
            render();
        }

        function removeRow(index) {
            if (confirm(`Delete "${hosts[index].name}"?`)) {
                hosts.splice(index, 1);
                render();
            }
        }

        function update(index, field, value) {
            if (field === 'port' || field === 'x' || field === 'y' || field === 'sshPort') {
                value = (value === '' || value === null) ? null : parseFloat(value);
            }
            if (field === 'primaryParentId' || field === 'secondaryParentId') {
                value = value === '' ? null : value;
            }
            hosts[index][field] = value;
            render();
        }

        function updateIconType(index, value) {
            hosts[index].iconType = value;
            render();
        }

        // ============================================
        // Config Management
        // ============================================

        async function saveConfig() {
            const config = {
                settings: {
                    showGrid: document.getElementById('showGridCheck').checked,
                    snapToGrid: document.getElementById('snapToGridCheck').checked
                },
                nodes: hosts
            };

            if (window.electronAPI) {
                const result = await window.electronAPI.config.save(config);
                if (result.success) {
                    showToast('Configuration saved!', 'success');
                } else {
                    showToast('Failed to save: ' + result.error, 'error');
                }
            } else {
                // Browser download fallback
                downloadConfig(config);
            }
        }

        async function exportConfig() {
            const config = {
                settings: {
                    showGrid: document.getElementById('showGridCheck').checked,
                    snapToGrid: document.getElementById('snapToGridCheck').checked
                },
                nodes: hosts
            };

            if (window.electronAPI) {
                await window.electronAPI.config.export(config);
            } else {
                downloadConfig(config);
            }
        }

        function downloadConfig(config) {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(config, null, 2));
            const dl = document.createElement('a');
            dl.setAttribute("href", dataStr);
            dl.setAttribute("download", "config.json");
            document.body.appendChild(dl);
            dl.click();
            dl.remove();
        }

        async function importConfig() {
            if (window.electronAPI) {
                const result = await window.electronAPI.config.import();
                if (result.success) {
                    hosts = (result.config.nodes || []).map(normalizeHost);
                    settings = result.config.settings || settings;
                    document.getElementById('showGridCheck').checked = settings.showGrid;
                    document.getElementById('snapToGridCheck').checked = settings.snapToGrid !== false;
                    render();
                    showToast('Configuration imported!', 'success');
                }
            } else {
                // Browser file input
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = (e) => {
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        try {
                            const parsed = JSON.parse(ev.target.result);
                            hosts = (parsed.nodes || []).map(normalizeHost);
                            settings = parsed.settings || settings;
                            document.getElementById('showGridCheck').checked = settings.showGrid;
                            document.getElementById('snapToGridCheck').checked = settings.snapToGrid !== false;
                            render();
                        } catch (err) {
                            alert("Invalid config file.");
                        }
                    };
                    reader.readAsText(e.target.files[0]);
                };
                input.click();
            }
        }

        // ============================================
        // Navigation
        // ============================================

        function goBack() {
            window.location.href = 'index.html';
        }

        // ============================================
        // Utilities
        // ============================================

        function escapeHtml(s) {
            return String(s || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `fixed bottom-4 right-4 px-4 py-3 rounded-lg shadow-lg text-sm font-medium z-50 ${
                type === 'success' ? 'bg-green-600' : type === 'error' ? 'bg-red-600' : 'bg-blue-600'
            } text-white`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
