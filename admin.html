<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Network Monitor Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="bg-slate-900 text-slate-200 p-10 font-sans">

    <div class="max-w-[1400px] mx-auto">
        <div class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-3xl font-bold text-white">Network Topology Admin</h1>
                <p class="text-slate-400 text-sm mt-1">Configure hosts, failover paths, and layout positions.</p>
            </div>
            <div class="flex items-center space-x-6">
                <div class="flex items-center space-x-2 bg-slate-800 px-4 py-2 rounded border border-slate-700">
                    <input type="checkbox" id="showGridCheck" class="w-4 h-4 rounded bg-slate-700 border-slate-500 text-blue-600 focus:ring-blue-500">
                    <label for="showGridCheck" class="text-sm font-medium text-slate-300 cursor-pointer">Show Grid</label>
                </div>

                <div class="space-x-4">
                    <label class="cursor-pointer bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded transition text-sm font-medium">
                        Import config.json
                        <input type="file" id="fileInput" class="hidden" accept=".json">
                    </label>
                    <button onclick="saveConfig()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded font-bold transition shadow-lg shadow-blue-500/20 text-sm">
                        Download config.json
                    </button>
                </div>
            </div>
        </div>

        <!-- Editor Table -->
        <div class="bg-slate-800 rounded-xl border border-slate-700 overflow-hidden shadow-xl overflow-x-auto">
            <table class="w-full text-left border-collapse min-w-[1200px]">
                <thead class="bg-slate-900/50 text-slate-400 uppercase text-xs font-bold tracking-wider">
                    <tr>
                        <th class="p-4">Node Name</th>
                        <th class="p-4">IP Address / Port</th>
                        <th class="p-4">Parents</th>
                        <th class="p-4 w-72">Layout (Grid Cell)</th>
                        <th class="p-4">Icon</th>
                        <th class="p-4 text-center">Preview</th>
                        <th class="p-4 text-right"></th>
                    </tr>
                </thead>
                <tbody id="hostList"></tbody>
            </table>
            
            <div class="p-4 bg-slate-900/30 border-t border-slate-700">
                <button onclick="addRow()" class="w-full py-3 border-2 border-dashed border-slate-600 text-slate-500 rounded hover:border-slate-400 hover:text-slate-300 transition flex items-center justify-center gap-2 font-medium">
                    <i data-lucide="plus-circle"></i> Add New Device Node
                </button>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-8">
            <div class="p-6 bg-blue-900/20 border border-blue-600/30 rounded-lg text-blue-200 text-sm">
                 <strong class="block mb-3 text-blue-400 text-lg flex items-center gap-2"><i data-lucide="move" class="w-5 h-5"></i> Extended Grid</strong>
                <p class="text-blue-300/80">Grid now extends from <strong>A to AZ</strong> and <strong>Rows 1-50</strong>.</p>
                <p class="text-blue-300/80 mt-1">Use the dropdowns to place hosts on the extended map.</p>
            </div>
            <div class="p-6 bg-red-900/20 border border-red-600/30 rounded-lg text-red-200 text-sm">
                <strong class="block mb-3 text-red-400 text-lg flex items-center gap-2"><i data-lucide="zap" class="w-5 h-5"></i> Failover</strong>
                <p class="text-red-300/80">System switches to Secondary Parent if Primary is offline.</p>
            </div>
            <div class="p-6 bg-purple-900/20 border border-purple-600/30 rounded-lg text-purple-200 text-sm">
                <strong class="block mb-3 text-purple-400 text-lg flex items-center gap-2"><i data-lucide="image" class="w-5 h-5"></i> Custom Icons (SVG)</strong>
                <p class="text-purple-300/80">Select <strong>SVG</strong> type to paste raw <code>&lt;svg&gt;...&lt;/svg&gt;</code> code directly.</p>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();
        let hosts = [];
        let settings = { showGrid: true }; 

        // Generate Columns A-Z, AA-AZ
        const gridCols = [];
        for (let i = 0; i < 26; i++) gridCols.push(String.fromCharCode(65 + i));
        for (let i = 0; i < 26; i++) gridCols.push('A' + String.fromCharCode(65 + i)); // AA..AZ (Total 52 cols)

        async function loadDefault() {
            try {
                const res = await fetch('config.json');
                if (res.ok) {
                    const data = await res.json();
                    if (Array.isArray(data)) hosts = data.map(normalizeHost);
                    else {
                        hosts = data.nodes.map(normalizeHost);
                        settings = data.settings || settings;
                    }
                } else hosts = [];
            } catch (e) { hosts = []; }
            
            document.getElementById('showGridCheck').checked = settings.showGrid;
            render();
        }

        function normalizeHost(h) {
             return {
                id: h.id || ('node_' + Date.now() + '_' + Math.floor(Math.random()*1000)),
                name: h.name || 'Unnamed',
                address: h.address || '',
                port: (h.port === '' || typeof h.port === 'undefined') ? null : h.port,
                primaryParentId: (h.primaryParentId && h.primaryParentId !== '') ? h.primaryParentId : null,
                secondaryParentId: (h.secondaryParentId && h.secondaryParentId !== '') ? h.secondaryParentId : null,
                icon: h.icon || 'circle',
                iconType: h.iconType || 'lucide',
                x: (h.x === null || h.x === '') ? null : h.x,
                y: (h.y === null || h.y === '') ? null : h.y
            };
        }

        function render() {
            const tbody = document.getElementById('hostList');
            tbody.innerHTML = '';

            hosts.forEach((host, index) => {
                const tr = document.createElement('tr');
                tr.className = "border-b border-slate-700 hover:bg-slate-700/30 transition group";

                const createParentOptions = (currentParentId) => {
                    let options = `<option value="" ${currentParentId === null ? 'selected' : ''}>No Parent (Root)</option>`;
                    hosts.forEach(h => {
                        if (h.id !== host.id) {
                            const selected = currentParentId === h.id ? 'selected' : '';
                            options += `<option value="${h.id}" ${selected}>${escapeHtml(h.name)}</option>`;
                        }
                    });
                    return options;
                };

                // Generate Column Options
                let colOptions = `<option value="">-</option>`;
                gridCols.forEach((char, i) => {
                    const expectedX = (i * 5) + 2.5;
                    const isSelected = (host.x !== null && Math.abs(host.x - expectedX) < 0.1);
                    colOptions += `<option value="${char}" ${isSelected ? 'selected' : ''}>${char}</option>`;
                });

                // Generate Row Options (1-50)
                let rowOptions = `<option value="">-</option>`;
                for(let i=1; i<=50; i++) {
                    const expectedY = ((i - 1) * 5) + 2.5;
                    const isSelected = (host.y !== null && Math.abs(host.y - expectedY) < 0.1);
                    rowOptions += `<option value="${i}" ${isSelected ? 'selected' : ''}>${i}</option>`;
                }

                const iconPlaceholder = host.iconType === 'svg' ? 'Paste <svg> code here' : 'name';

                tr.innerHTML = `
                    <td class="p-3 align-top">
                        <input type="text" value="${escapeHtml(host.name)}" onchange="update(${index}, 'name', this.value)" class="bg-slate-900 border border-slate-600 rounded px-3 py-1.5 w-full text-sm focus:border-blue-500 outline-none text-slate-200 placeholder-slate-600 mb-1" placeholder="Device Name">
                    </td>
                    <td class="p-3 align-top">
                        <div class="flex gap-1 mb-1">
                            <input type="text" value="${escapeHtml(host.address)}" onchange="update(${index}, 'address', this.value)" class="bg-slate-900 border border-slate-600 rounded px-2 py-1.5 w-32 text-sm font-mono focus:border-blue-500 outline-none text-slate-200 placeholder-slate-600" placeholder="IP Address">
                            <input type="number" value="${host.port || ''}" onchange="update(${index}, 'port', this.value)" class="bg-slate-900 border border-slate-600 rounded px-2 py-1.5 w-16 text-sm font-mono focus:border-blue-500 outline-none text-slate-200 placeholder-slate-600" placeholder="Port">
                        </div>
                    </td>
                    <td class="p-3 align-top">
                        <div class="flex flex-col gap-1">
                            <select onchange="update(${index}, 'primaryParentId', this.value)" class="bg-slate-900 border border-slate-600 rounded px-2 py-1.5 w-full text-xs outline-none text-slate-200 cursor-pointer hover:bg-slate-800">
                                <option disabled>Primary Parent</option>
                                ${createParentOptions(host.primaryParentId)}
                            </select>
                            <select onchange="update(${index}, 'secondaryParentId', this.value)" class="bg-slate-900 border border-slate-600 rounded px-2 py-1.5 w-full text-xs outline-none text-slate-200 cursor-pointer hover:bg-slate-800">
                                <option disabled>Failover Parent</option>
                                ${createParentOptions(host.secondaryParentId)}
                            </select>
                        </div>
                    </td>
                    <td class="p-3 align-top bg-slate-800/50 rounded">
                        <div class="flex flex-col gap-2">
                            <!-- GRID CELL SELECTS -->
                            <div class="flex items-center gap-2">
                                <span class="text-[10px] text-slate-400">Grid:</span>
                                <select onchange="updateGridCol(${index}, this.value)" class="bg-slate-700 border border-slate-500 rounded px-1 py-1 w-14 text-xs text-white outline-none cursor-pointer">
                                    ${colOptions}
                                </select>
                                <select onchange="updateGridRow(${index}, this.value)" class="bg-slate-700 border border-slate-500 rounded px-1 py-1 w-14 text-xs text-white outline-none cursor-pointer">
                                    ${rowOptions}
                                </select>
                            </div>
                            
                            <div class="flex gap-1 items-center">
                                <span class="text-[10px] text-slate-500">X%</span>
                                <input type="number" value="${host.x !== null ? host.x : ''}" onchange="update(${index}, 'x', this.value)" class="bg-slate-900 border border-slate-600 rounded px-1 py-1 w-12 text-xs font-mono focus:border-blue-500" placeholder="Auto">
                                <span class="text-[10px] text-slate-500 ml-1">Y%</span>
                                <input type="number" value="${host.y !== null ? host.y : ''}" onchange="update(${index}, 'y', this.value)" class="bg-slate-900 border border-slate-600 rounded px-1 py-1 w-12 text-xs font-mono focus:border-blue-500" placeholder="Auto">
                            </div>
                        </div>
                    </td>
                    <td class="p-3 align-top">
                        <div class="flex gap-1 items-center">
                             <select onchange="updateIconType(${index}, this.value)" class="bg-slate-900 border border-slate-600 rounded text-xs p-1.5 w-14 mr-1 text-slate-300 cursor-pointer">
                                <option value="lucide" ${host.iconType === 'lucide' ? 'selected' : ''}>Icon</option>
                                <option value="url" ${host.iconType === 'url' ? 'selected' : ''}>URL</option>
                                <option value="svg" ${host.iconType === 'svg' ? 'selected' : ''}>SVG</option>
                            </select>
                            <input type="text" value="${escapeHtml(host.icon)}" onchange="update(${index}, 'icon', this.value)" class="bg-slate-900 border border-slate-600 rounded px-2 py-1.5 w-full text-xs outline-none text-slate-200 placeholder-slate-600" placeholder="${iconPlaceholder}">
                        </div>
                    </td>
                    <td class="p-3 text-center align-top">
                        <div class="w-8 h-8 bg-slate-800 rounded-full flex items-center justify-center border border-slate-600 mx-auto overflow-hidden shadow-sm">
                            ${renderIconPreview(host)}
                        </div>
                    </td>
                    <td class="p-3 text-right align-top">
                        <button onclick="removeRow(${index})" class="text-slate-500 hover:text-red-400 hover:bg-red-900/20 p-2 rounded transition"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            lucide.createIcons();
        }

        function renderIconPreview(host) {
            if (host.iconType === 'url') {
                return `<img src="${host.icon}" class="w-full h-full object-cover" onerror="this.style.display='none'">`;
            }
            if (host.iconType === 'svg') {
                // If it looks like valid SVG, render it. Otherwise, show a placeholder.
                const svgContent = host.icon.trim();
                if (svgContent.startsWith('<svg') && svgContent.endsWith('>')) {
                    return host.icon;
                }
                return `<div class="text-xs text-slate-500">SVG Content...</div>`;
            }
            return `<i data-lucide="${host.icon || 'circle'}" class="w-4 h-4 text-slate-400"></i>`;
        }

        function addRow() {
            hosts.push(normalizeHost({}));
            render();
        }

        function removeRow(index) {
            hosts.splice(index, 1);
            render();
        }

        function update(index, field, value) {
            if (field === 'port' || field === 'x' || field === 'y') {
                value = (value === '' || value === null) ? null : parseFloat(value);
            }
            if (field === 'primaryParentId' || field === 'secondaryParentId') {
                value = value === '' ? null : value;
            }
            hosts[index][field] = value;
            render();
        }

        function updateGridCol(index, val) {
            if(!val) {
                hosts[index].x = null;
            } else {
                const colIndex = gridCols.indexOf(val);
                hosts[index].x = (colIndex * 5) + 2.5;
            }
            render();
        }

        function updateGridRow(index, val) {
            if(!val) {
                hosts[index].y = null;
            } else {
                const rowNum = parseInt(val);
                hosts[index].y = ((rowNum - 1) * 5) + 2.5;
            }
            render();
        }

        function updateIconType(index, value) {
            hosts[index].iconType = value;
            render();
        }

        function saveConfig() {
            const currentSettings = {
                showGrid: document.getElementById('showGridCheck').checked
            };
            const exportData = {
                settings: currentSettings,
                nodes: hosts
            };
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(exportData, null, 2));
            const dl = document.createElement('a');
            dl.setAttribute("href", dataStr);
            dl.setAttribute("download", "config.json");
            document.body.appendChild(dl);
            dl.click();
            dl.remove();
        }

        document.getElementById('fileInput').addEventListener('change', function (e) {
            const reader = new FileReader();
            reader.onload = function (ev) {
                try {
                    const parsed = JSON.parse(ev.target.result);
                    if(Array.isArray(parsed)) hosts = parsed.map(normalizeHost);
                    else {
                        hosts = parsed.nodes.map(normalizeHost);
                        settings = parsed.settings || settings;
                    }
                    document.getElementById('showGridCheck').checked = settings.showGrid;
                    render();
                } catch (err) {
                    alert("Invalid Config File.");
                }
            };
            reader.readAsText(e.target.files[0]);
        });

        function escapeHtml(s) {
            return String(s).replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;').replaceAll('"', '&quot;').replaceAll("'", '&#39;');
        }

        loadDefault();
    </script>
</body>
</html>
